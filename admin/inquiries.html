<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inquiries - Parti Poodles Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background: #2D5A27;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 1.25rem; }
        
        .header-right { display: flex; align-items: center; gap: 1rem; }
        
        .back-btn, .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .back-btn:hover, .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .page-header h2 { color: #333; }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .filters select, .filters input {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
        
        th { background: #f9f9f9; font-weight: 600; color: #333; }
        
        tr:hover { background: #fafafa; }
        
        .status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status.new { background: #e3f2fd; color: #1565c0; }
        .status.contacted { background: #fff3e0; color: #ef6c00; }
        .status.resolved { background: #e8f5e9; color: #2e7d32; }
        .status.closed { background: #f5f5f5; color: #666; }
        
        .actions button {
            background: #2D5A27;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        
        .actions button:hover { background: #1a3517; }
        .actions button.secondary { background: #666; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h3 { color: #333; }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-group { margin-bottom: 1rem; }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-group textarea { min-height: 100px; resize: vertical; }
        
        .detail-row { margin-bottom: 1rem; }
        .detail-row strong { color: #333; }
        .detail-row p { color: #666; margin-top: 0.25rem; }
        
        .loading { text-align: center; padding: 3rem; color: #666; }
        
        .empty { text-align: center; padding: 3rem; color: #666; }
    </style>
</head>
<body>
    <header class="header">
        <h1>Parti Poodles Admin</h1>
        <div class="header-right">
            <a href="/admin/dashboard.html" class="back-btn">‚Üê Dashboard</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>
    
    <div class="container">
        <div class="page-header">
            <h2>Customer Inquiries</h2>
        </div>
        
        <div class="filters">
            <select id="status-filter" onchange="filterInquiries()">
                <option value="">All Status</option>
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
            </select>
            <input type="text" id="search" placeholder="Search by name or email..." onkeyup="filterInquiries()">
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Interest</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inquiries-table">
                    <tr><td colspan="6" class="loading">Loading inquiries...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- View/Edit Modal -->
    <div class="modal" id="inquiry-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Inquiry Details</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script>
        const CONVEX_URL = 'https://dapper-warthog-727.convex.cloud';
        let allInquiries = [];
        
        // Check auth
        if (!sessionStorage.getItem('adminUser')) {
            window.location.href = '/admin/';
        }
        
        function logout() {
            sessionStorage.removeItem('adminUser');
            window.location.href = '/admin/';
        }
        
        async function queryConvex(path, args = {}) {
            const response = await fetch(`${CONVEX_URL}/api/query`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, args, format: 'json' })
            });
            const data = await response.json();
            return data.value;
        }
        
        async function mutateConvex(path, args = {}) {
            const response = await fetch(`${CONVEX_URL}/api/mutation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, args, format: 'json' })
            });
            return await response.json();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-AU', { 
                day: 'numeric', month: 'short', year: 'numeric' 
            });
        }
        
        function renderInquiries(inquiries) {
            const tbody = document.getElementById('inquiries-table');
            
            if (!inquiries || inquiries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No inquiries found</td></tr>';
                return;
            }
            
            // Sort by date, newest first
            inquiries.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            tbody.innerHTML = inquiries.map(inq => `
                <tr>
                    <td>${formatDate(inq.created_at)}</td>
                    <td>${inq.customer_name || 'Unknown'}</td>
                    <td>${inq.email || '-'}</td>
                    <td>${inq.puppy_interest || '-'}</td>
                    <td><span class="status ${inq.status || 'new'}">${inq.status || 'new'}</span></td>
                    <td class="actions">
                        <button onclick="viewInquiry('${inq._id}')">View</button>
                        <button class="secondary" onclick="updateStatus('${inq._id}')">Update</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterInquiries() {
            const status = document.getElementById('status-filter').value;
            const search = document.getElementById('search').value.toLowerCase();
            
            let filtered = allInquiries;
            
            if (status) {
                filtered = filtered.filter(i => (i.status || 'new') === status);
            }
            
            if (search) {
                filtered = filtered.filter(i => 
                    (i.customer_name || '').toLowerCase().includes(search) ||
                    (i.email || '').toLowerCase().includes(search)
                );
            }
            
            renderInquiries(filtered);
        }
        
        function viewInquiry(id) {
            const inq = allInquiries.find(i => i._id === id);
            if (!inq) return;
            
            document.getElementById('modal-title').textContent = 'Inquiry Details';
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-row">
                    <strong>Customer Name</strong>
                    <p>${inq.customer_name || 'Unknown'}</p>
                </div>
                <div class="detail-row">
                    <strong>Email</strong>
                    <p>${inq.email || '-'}</p>
                </div>
                <div class="detail-row">
                    <strong>Phone</strong>
                    <p>${inq.phone || '-'}</p>
                </div>
                <div class="detail-row">
                    <strong>Puppy Interest</strong>
                    <p>${inq.puppy_interest || '-'}</p>
                </div>
                <div class="detail-row">
                    <strong>Message</strong>
                    <p>${inq.message || '-'}</p>
                </div>
                <div class="detail-row">
                    <strong>Status</strong>
                    <p><span class="status ${inq.status || 'new'}">${inq.status || 'new'}</span></p>
                </div>
                <div class="detail-row">
                    <strong>Date</strong>
                    <p>${formatDate(inq.created_at)}</p>
                </div>
                ${inq.response ? `
                <div class="detail-row">
                    <strong>Response</strong>
                    <p>${inq.response}</p>
                </div>
                ` : ''}
            `;
            document.getElementById('inquiry-modal').classList.add('show');
        }
        
        function updateStatus(id) {
            const inq = allInquiries.find(i => i._id === id);
            if (!inq) return;
            
            document.getElementById('modal-title').textContent = 'Update Inquiry';
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="saveInquiry(event, '${id}')">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="edit-status">
                            <option value="new" ${inq.status === 'new' ? 'selected' : ''}>New</option>
                            <option value="contacted" ${inq.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                            <option value="resolved" ${inq.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                            <option value="closed" ${inq.status === 'closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Response Notes</label>
                        <textarea id="edit-response">${inq.response || ''}</textarea>
                    </div>
                    <button type="submit" style="width:100%;padding:0.75rem;background:#2D5A27;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;">Save Changes</button>
                </form>
            `;
            document.getElementById('inquiry-modal').classList.add('show');
        }
        
        async function saveInquiry(e, id) {
            e.preventDefault();
            
            const status = document.getElementById('edit-status').value;
            const response = document.getElementById('edit-response').value;
            
            try {
                await mutateConvex('inquiries:update', { id, status, response });
                closeModal();
                loadInquiries();
            } catch (err) {
                alert('Error saving: ' + err.message);
            }
        }
        
        function closeModal() {
            document.getElementById('inquiry-modal').classList.remove('show');
        }
        
        async function loadInquiries() {
            try {
                allInquiries = await queryConvex('inquiries:list') || [];
                renderInquiries(allInquiries);
            } catch (err) {
                console.error('Error loading inquiries:', err);
                document.getElementById('inquiries-table').innerHTML = 
                    '<tr><td colspan="6" class="empty">Error loading inquiries</td></tr>';
            }
        }
        
        // Close modal on outside click
        document.getElementById('inquiry-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) closeModal();
        });
        
        loadInquiries();
    </script>
</body>
</html>
